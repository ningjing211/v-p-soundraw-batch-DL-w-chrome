import{o as h,s as K,y as C}from"./RHEDGG6N.js";import{b as O}from"./ENA3LJHP.js";import{a as I,c as L}from"./DPE42NE6.js";import{Fa as M,i as w,lb as U,m as R,o as b,p as B,q as F,s as g}from"./ONVH27HX.js";import{a as x}from"./4B6UFNBQ.js";import{f as T,h as y}from"./GAV6HCJA.js";var S=T(K());var f=class{constructor(){this.cacheService=new h({saveKey:"MAXAI_CLIENT__FEATURES__BILLING__FEATURES_USAGE",cacheTime:e=>(0,S.default)().isSame((0,S.default)(e),"day")})}async fetchFeaturesQuota(){let e=await M.fetch("/user/get_user_feature_quota");if(e.data?.status==="OK"){let t=e.data.data;return{summarizePage:{dailyQuota:t.SUMMARIZE_PAGE_REQUEST_MAX_CNT},summarizePDF:{dailyQuota:t.SUMMARIZE_PDF_REQUEST_MAX_CNT},summarizeYoutube:{dailyQuota:t.SUMMARIZE_YOUTUBE_VIDEO_REQUEST_MAX_CNT},contextMenu:{dailyQuota:t.CONTEXT_MENU_REQUEST_MAX_CNT},search:{dailyQuota:t.SEARCH_REQUEST_MAX_CNT},instantReply:{dailyQuota:t.INSTANT_REPLY_REQUEST_MAX_CNT}}}return null}async getFeaturesUsage(e){let t={summarizePage:{dailyQuota:0,todayUsage:0},summarizePDF:{dailyQuota:0,todayUsage:0},summarizeYoutube:{dailyQuota:0,todayUsage:0},contextMenu:{dailyQuota:100,todayUsage:0},instantReply:{dailyQuota:0,todayUsage:0},search:{dailyQuota:0,todayUsage:0},refreshTime:""},o=await this.cacheService.get();if(o.data&&(t=U(t,o.data)),e||o.expired){let s=await this.fetchFeaturesQuota();s&&(t=U(t,s),await this.cacheService.sync(t))}return(!t.refreshTime||!(0,S.default)().isSame((0,S.default)(t.refreshTime),"day"))&&(t=U(t,{refreshTime:new Date().toISOString(),summarizePage:{todayUsage:0},summarizePDF:{todayUsage:0},summarizeYoutube:{todayUsage:0},contextMenu:{todayUsage:0},instantReply:{todayUsage:0},search:{todayUsage:0}}),await this.cacheService.set(t)),t}async setFeaturesUsage(e,t){let o=await this.getFeaturesUsage(!1);o[e].todayUsage=t,await this.cacheService.set(o)}async syncFeaturesUsage(){return this.getFeaturesUsage(!0)}async clearFeaturesUsage(){await this.cacheService.clear()}};y([I()],f.prototype,"getFeaturesUsage",1);var Q="CHROME_EXTENSION_USE_CHAT_GPT_AI_USER_FEATURE_QUOTA_SAVE_KEY",E=class extends f{constructor(){super(),this.init()}async init(){let e=await g.getItem(Q);if(e){await g.remove(Q);let t={contextMenu:{dailyQuota:e.contextMenuMaxCnt||0,todayUsage:e.contextMenuUsage||0},instantReply:{dailyQuota:e.instantReplyMaxCnt||0,todayUsage:e.instantReplyUsage||0},summarizePage:{dailyQuota:e.summarizePageMaxCnt||0,todayUsage:e.summarizePageUsage||0},summarizePDF:{dailyQuota:e.summarizePDFMaxCnt||0,todayUsage:e.summarizePDFUsage||0},summarizeYoutube:{dailyQuota:e.summarizeYoutubeMaxCnt||0,todayUsage:e.summarizeYoutubeUsage||0},search:{dailyQuota:e.searchMaxCnt||0,todayUsage:e.searchUsage||0},refreshTime:e.refreshTime};await this.cacheService.set(t,{syncTime:e.checkTime})}}};var le=new E;var p=class extends L{constructor(){super(...arguments);this.modelUsageCacheService=new h({saveKey:"MAXAI_CLIENT__FEATURES__BILLING__MODEL_USAGE",cacheTime:h.DAILY})}async fetchModelUsage(){let t=await M.fetch("/user/get_user_quota_usage");if(t.data?.status==="OK"){let o=t.data.data;return{fastText:o.fast_text,advancedText:o.advanced_text,imageGenerate:o.image_generate,contentChat:o.content_chat,nextRefreshTime:o.next_refresh_time,proChat:o.pro_chat,proChatReward:o.pro_chat_reward}}return null}async getModelUsage(t){let o={fastText:0,advancedText:0,imageGenerate:0,contentChat:0,proChat:0,proChatReward:0},s=await this.modelUsageCacheService.get();if(s.data&&(Object.assign(o,s.data),s.data={...o}),t||s.expired){let n=await this.fetchModelUsage();n&&(Object.assign(o,n),await this.modelUsageCacheService.sync(o))}return s.data&&(s.data.proChat!==o.proChat||s.data.proChatReward!==o.proChatReward)&&this.emit("onUsageChange",s.data,o),o}async refreshModelUsage(){return await this.getModelUsage(!0)}async clearModelUsage(){await this.modelUsageCacheService.clear()}};y([I()],p.prototype,"getModelUsage",1);var N="CHROME_EXTENSION_USE_CHAT_GPT_AI_USER_QUOTA_USAGE_SAVE_KEY",P=class extends p{constructor(){super(),this.init()}async init(){let e=await g.getItem(N);e&&(await g.remove(N),await this.modelUsageCacheService.set(e))}};var A=new P;var _=w({key:"BillingModelUsageModelAtom",default:{fastText:0,advancedText:0,imageGenerate:0,contentChat:0,proChat:0,proChatReward:0,loading:!1}});var m=T(x());var j=()=>R(_),V=()=>{let a=b(_),e=B(_),t=(0,m.useCallback)(r=>{a(i=>i.loading===r?i:{...i,loading:r})},[]),o=(0,m.useCallback)(async()=>{t(!0);let r=await A.getModelUsage();a(i=>({...i,...r})),t(!1)},[]),s=(0,m.useCallback)(async()=>{t(!0);let r=await A.refreshModelUsage();a(i=>({...i,...r,synced:!0})),t(!1)},[t]),n=F(({snapshot:r})=>async()=>{let{synced:i}=await r.getPromise(_);i||await s()},[s]),u=(0,m.useCallback)(async()=>{await A.clearModelUsage(),e()},[]),c=(0,m.useCallback)(O(s,500),[s]);return{loadModelUsage:o,clearModelUsage:u,refreshModelUsage:s,refreshModelUsageOnce:n,debounceRefreshModelUsage:c}},Be=()=>{let a=j(),e=V();return{loading:a.loading,modelUsage:a,...e}};var D=a=>{let e,t=new Set,o=(i,d)=>{let l=typeof i=="function"?i(e):i;if(!Object.is(l,e)){let k=e;e=d??(typeof l!="object"||l===null)?l:Object.assign({},e,l),t.forEach(H=>H(e,k))}},s=()=>e,c={setState:o,getState:s,getInitialState:()=>r,subscribe:i=>(t.add(i),()=>t.delete(i))},r=e=a(o,s,c);return c},z=a=>a?D(a):D;var v=T(x(),1);var W=a=>a;function Z(a,e=W){let t=v.default.useSyncExternalStore(a.subscribe,()=>e(a.getState()),()=>e(a.getInitialState()));return v.default.useDebugValue(t),t}var G=a=>{let e=z(a),t=o=>Z(e,o);return Object.assign(t,e),t},Y=a=>a?G(a):G;var X=Y(a=>({onStartPolling:null,onCompletePolling:null,setOnStartPolling:e=>{a({onStartPolling:e})},setOnStopPolling:e=>{a({onCompletePolling:e})}})),ze=async a=>{if(await C.isLogin())return!0;let{maxWaitTime:t=3*60*1e3,customLoginCheck:o,emitEvent:s=!1}=a||{},{onStartPolling:n,onCompletePolling:u}=X.getState();if(s)if(n)await n();else return!1;return new Promise(async c=>{let r=null,i=async d=>{if(d?.data?.event==="MAX_AI_CONNECT_ACCOUNT"&&d.data.type==="COMPLETE"){window.removeEventListener("message",i),r&&clearTimeout(r);let l=o?await o():await C.isLogin();s&&u&&await u(l),c(l)}};r=setTimeout(()=>{c(!1)},t),window.addEventListener("message",i)})},Ge=a=>{X.getState().setOnStartPolling(a)};export{le as a,A as b,j as c,V as d,Be as e,z as f,Z as g,Y as h,ze as i,Ge as j};
